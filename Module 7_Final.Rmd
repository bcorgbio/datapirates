---
title: "Module 7"
author: "Data Pirates"
date: "2022-11-27"
output: html_document
bibliography:BIOL3140_datapirates_mod7.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)
```

## Introduction
This project explored the effect of length on muscle force generation and evaluated how fatigue affects this force-length relationship. Eccentric fatigue has been a particular interest to muscle physiologists lately. This research has shown that the force/torque-length/angle relationship shifts soon and long after eccentric fatigue. The sliding filament and cross-bridge theories of muscle contraction provide discrete predictions of the force length relationship of skeletal muscle that have been tested experimentally. The active force generated by a maximally activated single fiber is maximal when the filament overlap is optimized @rassier1999length. 

The human arm can be considered a 3rd order lever which also has a mechanical advantage that predicts the amount of output force transmitted by the input force. The input moment arm changes as the forearm flexes since the insertion angle changes as the forearm rotates. For this project, we followed the assumption that the force measured at the hand as the muscle produced isometric force at various lengths is a reasonable reflection of the force length relationship governing force at the fiber level. This project produced isometric force angle curves for the human forearm flexors undertaking maximum voluntary contractions at a number of different elbow angles in order to compare the angle at which the maximum isometric force occurs between non-fatigued and eccentrically fatigued forearm flexors.


## Methods

## Results
```{r,"loading in libraries"}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(MuMIn)
library(knitr)
```
```{r,"loading in data files"}
f <- list.files("Project 8 data/",full.names=TRUE)
dat.l <- list()

for(i in f){
  met.dat<- unlist(strsplit(i,"_")) 
  who <- met.dat[2] 
  angle <- met.dat[3]
  activity <- gsub(".csv","",met.dat[4]) 
  dat.l[[i]]<- read_csv(i,col_names=FALSE)%>%
    mutate(who=who,angle=angle,activity=activity)
}
dat <- do.call(rbind,dat.l)
dat$X1<-gsub("Reading: ","",as.character(dat$X1))
dat$X1 <- gsub("lbs","",as.character(dat$X1))
dat$X1 <- as.numeric(as.character(dat$X1))
```
```{r,"calculating max values and Fmax to add to table"}
max_value <- dat%>%
  group_by(who,angle,activity)%>%
  slice(which.max(X1))

fmax <- dat%>%
  group_by(activity,who)%>%
  slice(which.max(X1))
colnames(fmax) <- c("FMAX","who","angle_max","activity")

normalized_table <- merge(max_value,fmax,by="who")%>%  
  filter(activity.x==activity.y)
normalized_table$fnorm <- (normalized_table$X1/normalized_table$FMAX)


df1 <- normalized_table%>%
  select(who,angle,activity.x,fnorm)
df1$angle <- as.numeric(as.character(df1$angle))
```
```{r,"separating fatigue and control data"}
df1_fatigue <- df1[df1$activity.x=="fatigue",]
fnorm_fatigue <- c(df1_fatigue$fnorm)
ang.F <- df1_fatigue$angle
df1_control <- df1[df1$activity.x=="control",]
fnorm_control <- c(df1_control$fnorm)
ang.C <- df1_control$angle
```
```{r,"linear models for control",results='hide'}
poly.m2 <- lm(fnorm~poly(angle,2),df1_control) #second order
poly.m3 <- lm(fnorm~poly(angle,3),df1_control) #third order
poly.m4 <- lm(fnorm~poly(angle,4),df1_control) #fourth order

AICc(poly.m2,poly.m3,poly.m4) #the fourth model fits the best
```
```{r,"creating force prediction based on 1000 angles, graphing data vs. predictive model, for control"}
x.pred <- seq(45,157.5,length.out = 1000) #define 1000 angles from our range

normF.pred <- predict(poly.m4,newdata = data.frame(angle=x.pred)) #predict the force using 1000 angles

qplot(ang.C,fnorm_control)+geom_point(aes(x=x.pred,y=normF.pred),col="red")+geom_point(aes(x=x.pred[which.max(normF.pred)],y=normF.pred[which.max(normF.pred)]),size=5,col="blue")+ylab("Normalized Force")+xlab("Angle")
                                                                                                  
```
Caption for graph 1 -- CONTROL force data vs. prediction model 
```{r,"linear models for fatigue",results='hide'}
poly.m2.fat <- lm(fnorm~poly(angle,2),df1_fatigue) #second order
poly.m3.fat <- lm(fnorm~poly(angle,3),df1_fatigue) #third order
poly.m4.fat <- lm(fnorm~poly(angle,4),df1_fatigue) #fourth order

AICc(poly.m2.fat,poly.m3.fat,poly.m4.fat) #the third order model fits best
```
```{r,"creating force prediction based on 1000 angles, graphing data vs. predictive model, for fatigue"}
normF.pred.fat <- predict(poly.m3.fat,newdata = data.frame(angle=x.pred)) #predict the force using 1000 angles

qplot(ang.F,fnorm_fatigue)+geom_point(aes(x=x.pred,y=normF.pred.fat),col="red")+geom_point(aes(x=x.pred[which.max(normF.pred.fat)],y=normF.pred.fat[which.max(normF.pred.fat)]),size=5,col="blue")+ylab("Normalized Force")+xlab("Angle")
```
Caption for graph 2 -- FATIGUE force data vs. prediction model. 
```{r,"prediction model angle maxes vs. actual data",results='hide"}
x.pred[which.max(normF.pred.fat)]-x.pred[which.max(normF.pred)]
ang.F[which.max(fnorm_fatigue)]-ang.C[which.max(fnorm_control)]
thetamax_diff_tibble <- tibble(Model="1000 Angle Prediction Model",ThetaDifference=x.pred[which.max(normF.pred.fat)]-x.pred[which.max(normF.pred)])
thetadifftable <- thetamax_diff_tibble%>%
  add_row(tibble(Model="Class Data",ThetaDifference=ang.F[which.max(fnorm_fatigue)]-ang.C[which.max(fnorm_control)]))
thetadifftable%>%
  kable(caption="Shift in Angle for Fmax in both 1000-Angle predictive model and in class data")
```
Caption for difference in predictive model vs. data (based off linear models for each)
```{r,"comparing control vs. fatigue data graphically" }
df1%>%
  ggplot(aes(angle,fnorm,col=activity.x))+geom_point()+ylab("Normalized Force")+xlab("Angle")
```
Caption for graph -- control vs. fatigue 

```{r,"figuring out best fit AIC model for data",results='hide'}
AICs <- df1%>%
  group_by(who,activity.x)%>%
  summarize(
    m2=AICc(lm(fnorm~poly(angle,2))), #second order
    m3=AICc(lm(fnorm~poly(angle,3))), #third order
    m4=AICc(lm(fnorm~poly(angle,4))) #fourth order
  )%>%
  pivot_longer(m2:m4,names_to="model",values_to="AICc")%>%
  print()

fits <- df1%>%
  group_by(who,activity.x)%>%
  summarize(
    m2=predict(lm(fnorm~poly(angle,2)),newdata=data.frame(angle=x.pred)), #second order
    m3=predict(lm(fnorm~poly(angle,3)),newdata=data.frame(angle=x.pred)), #third order
    m4=predict(lm(fnorm~poly(angle,4)),newdata=data.frame(angle=x.pred)) #fourth order
  )%>%
  pivot_longer(m2:m4,names_to="model")%>%
  group_by(who,activity.x,model)%>%
  summarize(theta_max=x.pred[which.max(value)])%>%
  print()

best.models <- fits%>%
  left_join(AICs)%>%
  group_by(who,activity.x)%>%
  mutate(best=AICc==min(AICc))%>%
  filter(best==TRUE)%>%
  dplyr::select(-best)%>%
  print()
```

## Discussion

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
